<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¤ãƒ™ãƒ³ãƒˆå±€ (åœ¨å®¤ç®¡ç†)</title>
    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #333333;
            --text-sub: #666666;
            --primary: #007bff;
            
            /* ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ©ãƒ¼ (ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã¨ã—ã¦ä½¿ç”¨) */
            --border-prof: #dc3545;
            --border-m2: #6f42c1;
            --border-b4: #0d6efd;
            
            /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ©ãƒ¼ */
            --status-present-bg: #d1e7dd;
            --status-present-text: #0f5132;
            --status-absent-bg: #f8f9fa;
            --status-absent-text: #6c757d;
        }

        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 15px;
        }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
        header {
            background-color: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        header h1 {
            margin: 0;
            font-size: 1.2rem;
            color: #333;
            font-weight: 700;
            /* â˜…ä¿®æ­£: æ”¹è¡Œã‚’ç¦æ­¢ã—ã€æ–‡å­—ãŒæ½°ã‚Œãªã„ã‚ˆã†ã«å›ºå®š */
            white-space: nowrap;
            flex-shrink: 0;
            margin-right: 20px;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼å³å´ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%; /* ã‚¹ãƒãƒ›ã§ã¯å¹…ã„ã£ã±ã„ */
            justify-content: space-between; /* ã‚¹ãƒãƒ›ã§ã¯å·¦å³ã«é…ç½® */
        }

        /* PCä»¥ä¸Šã§ã¯æ¨ªä¸¦ã³ */
        @media (min-width: 600px) {
            header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            /* â˜…ä¿®æ­£: PCã§ã¯å¹…ã‚’è‡ªå‹•èª¿æ•´ã—ã¦ã€ã‚¿ã‚¤ãƒˆãƒ«ã‚’åœ§è¿«ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ */
            .header-controls {
                width: auto;
                justify-content: flex-end;
            }
        }

        /* --- è¡¨ç¤ºåˆ‡æ›¿ã‚¹ã‚¤ãƒƒãƒ --- */
        #view-toggle {
            display: inline-flex;
            background-color: #e9ecef;
            border-radius: 20px;
            padding: 3px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.06);
        }
        .toggle-btn {
            border: none;
            background: transparent;
            padding: 8px 16px;
            border-radius: 18px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.2s ease;
            /* æ”¹è¡Œé˜²æ­¢ */
            white-space: nowrap;
        }
        .toggle-btn.active {
            background-color: #fff;
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #manage-link {
            font-size: 0.85rem;
            color: #6c757d;
            text-decoration: none;
            padding: 5px 10px;
            white-space: nowrap; /* æ”¹è¡Œé˜²æ­¢ */
        }

        /* --- ã‚«ãƒ†ã‚´ãƒªã‚»ã‚¯ã‚·ãƒ§ãƒ³ --- */
        .category-section {
            margin-bottom: 25px;
        }
        .category-header {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 10px;
            padding-left: 10px;
            border-left: 4px solid #ccc;
            color: #555;
            display: flex;
            align-items: center;
        }
        
        /* ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®è‰²åˆ†ã‘ãƒãƒ¼ */
        [id="Prof\."] .category-header { border-left-color: var(--border-prof); color: #a71d2a; }
        [id="M2"] .category-header { border-left-color: var(--border-m2); color: #59359a; }
        [id="B4"] .category-header { border-left-color: var(--border-b4); color: #0a58ca; }
        [id="ï¼‘å¹´"] .category-header { border-left-color: var(--border-b4); }
        [id="ï¼’å¹´"] .category-header { border-left-color: var(--border-m2); }

        /* --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒªãƒƒãƒ‰ --- */
        .user-grid {
            display: grid;
            /* ã‚¹ãƒãƒ›: 2åˆ— */
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px;
        }
        /* PC: ç”»é¢å¹…ã«å¿œã˜ã¦åˆ—ã‚’å¢—ã‚„ã™ */
        @media (min-width: 768px) {
            .user-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 15px;
            }
        }

        /* --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚«ãƒ¼ãƒ‰ --- */
        .user-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            border: 1px solid #eee;
            padding: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            min-height: 70px;
            transition: transform 0.1s;
            position: relative;
            overflow: hidden;
        }
        /* åœ¨å®¤æ™‚ã®ã‚«ãƒ¼ãƒ‰å¼·èª¿ */
        .user-card.present {
            border: 1px solid #badbcc;
            background-color: #fdfdfd;
            box-shadow: 0 3px 8px rgba(21, 87, 36, 0.1);
        }
        .user-card.absent {
            opacity: 0.7;
        }

        .user-name {
            font-weight: bold;
            font-size: 0.95rem;
            margin-bottom: 6px;
            color: var(--text-main);
            line-height: 1.3;
            word-break: break-all;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
        .status-badge {
            font-size: 0.75rem;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 600;
            display: inline-block;
        }
        .present .status-badge {
            background-color: var(--status-present-bg);
            color: var(--status-present-text);
        }
        .absent .status-badge {
            background-color: var(--status-absent-bg);
            color: var(--status-absent-text);
            border: 1px solid #dee2e6;
        }

        /* --- ç©ºã®çŠ¶æ…‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ --- */
        .empty-message {
            text-align: center;
            color: #999;
            padding: 40px 0;
            font-size: 0.9rem;
        }

    </style>
</head>
<body>

    <header>
        <h1>ã‚¤ãƒ™ãƒ³ãƒˆå±€ (åœ¨å®¤ç®¡ç†)</h1>
        
        <!-- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ç”¨ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ  -->
        <div class="header-controls">
            <div id="view-toggle">
                <button class="toggle-btn" data-view="all">å…¨å“¡</button>
                <button class="toggle-btn active" data-view="present">åœ¨å®¤è€…ã®ã¿</button>
            </div>
            
            <a href="login.html" id="manage-link">ç®¡ç†è¨­å®š &rsaquo;</a>
        </div>
    </header>

    <main id="dashboard-container"></main>

    <script>
        const API_URL = '/api/data';
        const container = document.getElementById('dashboard-container');

        // åˆæœŸè¡¨ç¤ºã¯ 'present' (åœ¨å®¤è€…ã®ã¿)
        let currentViewMode = 'present'; 
        
        let lastFetchedUsers = [];
        let lastFetchedStatus = {};

        /**
         * ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’å†æç”»ã™ã‚‹
         */
        async function updateDashboard() {
            try {
                const response = await fetch(API_URL + '?_=' + new Date().getTime());
                if (!response.ok) throw new Error('Server Error');
                
                const data = await response.json();
                
                lastFetchedUsers = data.users;
                lastFetchedStatus = data.status;

                renderDashboard(lastFetchedUsers, lastFetchedStatus);

            } catch (error) {
                console.error('Fetch error:', error);
            }
        }

        /**
         * ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦HTMLã‚’æ§‹ç¯‰ã™ã‚‹
         */
        function renderDashboard(users, statusData) {
            
            let usersToDisplay = users;

            if (currentViewMode === 'present') {
                usersToDisplay = users.filter(user => {
                    const statusInfo = statusData[user.mac] || {};
                    return statusInfo.status === 'åœ¨å®¤';
                });
            }

            if (usersToDisplay.length === 0) {
                if (currentViewMode === 'present') {
                    container.innerHTML = '<div class="empty-message">ç¾åœ¨ã€åœ¨å®¤è€…ã¯ã„ã¾ã›ã‚“ ğŸƒ</div>';
                } else {
                    container.innerHTML = '<div class="empty-message">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>ç®¡ç†ãƒšãƒ¼ã‚¸ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>';
                }
                return;
            }

            const categories = {};
            usersToDisplay.forEach(user => {
                if (!categories[user.category]) {
                    categories[user.category] = [];
                }
                categories[user.category].push(user);
            });

            const sortedCategories = Object.keys(categories).sort();
            
            let html = '';
            
            for (const categoryName of sortedCategories) {
                const categoryId = CSS.escape(categoryName);
                
                html += `
                    <section class="category-section" id="${categoryId}">
                        <div class="category-header">${categoryName}</div>
                        <div class="user-grid">
                `;

                for (const user of categories[categoryName]) {
                    const statusInfo = statusData[user.mac] || { status: 'ä¸æ˜' };
                    
                    let statusClass = 'absent';
                    let statusText = 'ä¸åœ¨';
                    
                    if (statusInfo.status === 'åœ¨å®¤') {
                        statusClass = 'present';
                        statusText = 'åœ¨å®¤'; 
                    }

                    html += `
                        <div class="user-card ${statusClass}">
                            <div class="user-name">${user.name}</div>
                            <div class="status-badge">${statusText}</div>
                        </div>
                    `;
                }
                html += `</div></section>`;
            }
            container.innerHTML = html;
        }

        /**
         * è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ–ã®å‡¦ç†
         */
        function handleViewToggle(event) {
            const clickedButton = event.target.closest('.toggle-btn');
            if (!clickedButton) return; 

            document.querySelectorAll('#view-toggle .toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            clickedButton.classList.add('active');
            currentViewMode = clickedButton.dataset.view;
            renderDashboard(lastFetchedUsers, lastFetchedStatus);
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('view-toggle').addEventListener('click', handleViewToggle);

        // åˆæœŸå®Ÿè¡Œã¨å®šæœŸå®Ÿè¡Œ
        updateDashboard(); 
        setInterval(updateDashboard, 10000);
    </script>

</body>
</html>